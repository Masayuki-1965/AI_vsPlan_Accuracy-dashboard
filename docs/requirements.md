# 需要予測vs計画値比較分析ダッシュボード 要件定義書

## 1. プロジェクト概要

### 1.1 開発目的
AIによる需要予測値と、事業部が策定した複数の現行計画値を実績値と比較し、誤差率に基づく評価・可視化を行う分析ダッシュボードを開発する。予測・計画と実績の乖離（ギャップ）を多角的に可視化し、欠品リスクや滞留リスクの早期把握を目的とする。

**業務用汎用ツールとしての設計方針**: 本アプリケーションは単発のデータ分析にとどまらず、誰でもデータを差し替えて再利用可能な汎用ツールとして設計する。データ依存性を可能な限り低く保ち、構成要素が柔軟に切り替えられる設計を意識し、社内展開に適した業務用途でのスケーラビリティを確保する。

### 1.2 技術スタック
- **フロントエンド・バックエンド**: Python + Streamlit
- **データ処理**: pandas, numpy
- **可視化**: plotly, matplotlib
- **データ形式**: CSV

## 2. データ仕様

### 2.1 データ項目仕様

| 項目名 | カラム名 | データ型 | 必須/任意 | 仕様内容 |
|--------|----------|----------|-----------|----------|
| 分類01 | Class_01 | str | 任意 | 全角・半角文字、日本語入力可 |
| 分類02 | Class_02 | str | 任意 | 全角・半角文字、日本語入力可 |
| ABC区分 | Class_abc | str | 任意 | 半角英数字 |
| 商品コード | P_code | str | 必須 | 半角英数字・半角カナのみ |
| 年月 | Date | str | 必須 | YYYYMM形式 |
| 実績値 | Actual | float | 必須 | 実数値 |
| AI予測値 | AI_pred | float | 必須 | 実数値 |
| 計画値01 | Plan_01 | float | 必須 | 実数値 |
| 計画値02 | Plan_02 | float | 任意 | 実数値 |

### 2.2 データの特性
- **AI予測値**: AIが生成した将来の月次予測（構成比は月別で変動）
- **計画値01／計画値02**: 直近Xヶ月の実績構成比を基に商品コード別に按分して作成した計画（構成比は月別で固定）
- **ファイル形式**: CSV（1行目はヘッダー、2行目以降がデータ）
- **カラム順序**: 不定（ユーザー側でマッピング設定）

### 2.3 サンプルデータ
- `20250530_インテリアデータ.csv`
- `20250611_ツインガード.csv`

## 3. 機能要件

### 3.1 データ入力・マッピング機能

#### 3.1.1 CSVファイルアップロード機能
- 単一CSVファイルのアップロード機能
- ファイル形式検証（CSV形式、文字エンコーディング対応）
- データ件数・サイズの表示

#### 3.1.2 データマッピング機能
- CSVヘッダー名とシステム項目名の対応付け
- ドロップダウンによる直感的なマッピング設定
- マッピング設定の保存・読み込み機能
- マッピング設定のプレビュー機能

#### 3.1.3 データ検証機能
- 必須項目の存在チェック
- データ型の妥当性検証
- 日付形式（YYYYMM）の検証
- 重複データの検出・警告

### 3.2 データ前処理機能

#### 3.2.1 データ補正機能
- 各月において、分類01・分類02の各カテゴリ単位で計画値01の合計と整合が取れるよう、AI予測値・計画値02に補正をかける
- 補正実施のON/OFF選択機能
- 補正前後の比較表示機能
- 補正係数の表示・出力機能

#### 3.2.2 データクレンジング機能
- 欠損値の処理（0埋め、除外等の選択）
- 異常値の検出・把握機能（分析目的での外れ値件数比較）
- データ統合・マージ機能

**注記**: 本アプリは予測ではなく分析を目的としているため、予測精度向上を目的としたデータクレンジングは不要。ただし、誤差率に大きな影響を与える異常値の件数比較は分析上有用。

### 3.3 評価・フィルター機能

#### 3.3.1 評価フィルター
- **分類フィルター**: Class_01／Class_02の複数選択対応
- **期間フィルター**: 年月（Date）の範囲指定・複数選択
- **ABC区分フィルター**: Class_abcの複数選択対応
- **商品コードフィルター**: 部分一致検索・複数選択対応

#### 3.3.2 評価指標の定義

##### 誤差率計算式
1. **絶対誤差率** = |計画 - 実績| ÷ 計画 ※誤差の大きさを評価
2. **正の誤差率** = (計画 - 実績) ÷ 計画 ※計画 > 実績：過剰計画／滞留リスク
3. **負の誤差率** = (計画 - 実績) ÷ 計画 ※計画 < 実績：過少計画／欠品リスク

##### 誤差率帯分類
- 0～10%、10～20%、20～30%、30～50%、50～100%、100%超、ゼロ予測

##### 平均誤差率の計算
**計画基準絶対誤差率** = |計画値 - 実績値| ÷ 計画値

**実績値重み付き加重平均誤差率** = Σ(計画基準絶対誤差率 × 実績値) ÷ Σ(実績値)

すなわち、「計画値を基準とした誤差率」を「実績値」で重みづけした加重平均を算出する。この指標により、AI予測／計画01／計画02の精度を定量的に比較・評価する。

## 4. 可視化要件

### 4.0 共通デザイン要件

#### 4.0.1 色分けルールの統一
全グラフにおいて、AI予測／計画01／計画02の色分けルールを統一する：
- **AI予測**: #FF6B6B（レッド系）
- **計画01**: #4ECDC4（ティール系）
- **計画02**: #45B7D1（ブルー系）

ユーザーが各モデルを一貫した視覚的識別で把握できるよう配慮する。

### 4.1 誤差率評価マトリクス

#### 4.1.1 表示内容
- 絶対誤差率、正の誤差率、負の誤差率それぞれのマトリクス
- 全体・ABC区分別・誤差率帯別の集計
- AI予測／計画値01／計画値02の比較表示
- 件数と加重平均値の表示

#### 4.1.2 インタラクティブ機能
- セルクリックによる詳細データのドリルダウン
- マトリクス内容のCSV出力機能
- 表示項目の動的切り替え

### 4.2 誤差率散布図

#### 4.2.1 グラフ仕様
- **縦軸**: 予測値または計画値
- **横軸**: 誤差率（0を中心に、右が正誤差、左が負誤差）
- **色分け**: ABC区分ごとに色分け（濃淡で区別）
- **比較表示**: AI予測／計画01／計画02の並列表示
- **平均誤差率表示**: ABC区分別（A・B・C区分のみ）に、商品コード別の絶対誤差を実績値で加重平均した平均誤差率を併記

#### 4.2.2 インタラクティブ機能
- 点のホバー表示（商品コード、詳細数値）
- 軸の範囲調整機能
- 点のクリックによる詳細情報表示
- ABC区分別平均誤差率の数値表示・ハイライト機能

### 4.3 絶対誤差率バブルチャート

#### 4.3.1 グラフ仕様
- **縦軸**: 予測値または計画値
- **横軸**: 絶対誤差率
- **バブルサイズ**: 機種数（予測値×誤差帯でグリッド分割し件数カウント）
- **比較表示**: AI予測／計画01／計画02の同一スケール比較
- **平均誤差率表示**: 商品コード別の絶対誤差を実績値で加重平均した平均誤差率を併記

#### 4.3.2 インタラクティブ機能
- バブルのホバー表示（件数、平均値等）
- スケール調整機能
- バブルクリックによる詳細表示
- 平均誤差率の数値表示・ハイライト機能

### 4.4 月次推移折れ線グラフ

#### 4.4.1 グラフ仕様
- 商品コード単位での月次推移表示
- AI予測／計画01／計画02／実績の重ね合わせ表示
- 複数商品の同時表示対応

#### 4.4.2 インタラクティブ機能
- 誤差マトリクスのセルクリックからの連動表示
- 商品コードの動的追加・削除
- フィルター指定時も全期間推移を表示
- グラフの拡大・縮小機能

## 5. ダッシュボード構成

### 5.1 画面構成

#### 5.1.1 メインナビゲーション
- サイドバーによるページ切り替え
- 以下のページ構成：
  1. データアップロード・設定
  2. 誤差率評価マトリクス
  3. 散布図分析
  4. バブルチャート分析
  5. 月次推移分析
  6. 設定・エクスポート

#### 5.1.2 共通UI要素
- グローバルフィルター（全ページ共通）
- データ更新状況の表示
- エラー・警告メッセージの表示
- 処理中インジケーター

### 5.2 レスポンシブデザイン
- PC、タブレット表示に最適化
- グラフの自動リサイズ機能
- フィルター項目の折りたたみ表示

## 6. 技術要件

### 6.1 パフォーマンス要件
- データ読み込み時間: 10,000件以下で5秒以内
- グラフ描画時間: 3秒以内
- フィルター適用時間: 1秒以内

### 6.2 互換性要件
- ブラウザ対応: Chrome, Firefox, Safari, Edge（最新版）
- Python バージョン: 3.8以上
- Streamlit バージョン: 1.20以上

### 6.3 セキュリティ要件
- アップロードファイルのサイズ制限（100MB以下）
- 許可されたファイル拡張子のみ受付（.csv）
- セッション管理によるデータ分離

## 7. 非機能要件

### 7.1 可用性
- アプリケーションの安定稼働
- エラー発生時の適切なメッセージ表示
- データ処理中の進捗表示

### 7.2 保守性
- モジュラー設計による保守性確保
- 設定ファイルによる柔軟な変更対応
- ログ出力機能

### 7.3 拡張性
- 新しい評価指標の追加容易性
- グラフタイプの追加対応
- データソースの多様化対応

## 8. 制約事項

### 8.1 技術的制約
- Streamlitの単一セッション制約
- メモリ使用量の制限
- ブラウザのJavaScript制限

### 8.2 データ制約
- CSVファイル形式のみ対応（単一ファイル）
- 最大データ件数: 100,000件
- 文字エンコーディング: UTF-8, Shift-JIS対応
- AI予測・計画01・計画02が同一CSV内に存在することが前提

## 9. 開発スケジュール（参考）

### Phase 1: 基盤開発（2週間）
- データ入力・マッピング機能
- 基本的なデータ処理・検証機能

### Phase 2: 分析機能開発（3週間）
- 誤差率計算エンジン
- 評価マトリクス機能
- 基本グラフ機能

### Phase 3: 高度な可視化（2週間）
- 散布図・バブルチャート
- 月次推移グラフ
- インタラクティブ機能

### Phase 4: 仕上げ・テスト（1週間）
- UI/UX改善
- パフォーマンス最適化
- 総合テスト

## 10. 成果物

### 10.1 ソースコード
- Streamlitアプリケーション
- データ処理モジュール
- 可視化モジュール
- 設定ファイル

### 10.2 ドキュメント
- ユーザーマニュアル
- 技術仕様書
- インストール・セットアップガイド

### 10.3 テストデータ
- サンプルCSVファイル
- テストケース定義書

---

**作成日**: 2024年12月28日  
**版数**: Ver 1.0  
**作成者**: AI Analysis Team 